<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERBAS | AI Triage System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --glass: rgba(30, 41, 59, 0.75); 
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            position: relative;
        }

        /* --- Particles Container --- */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1; 
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        
        /* --- Glassmorphism Cards --- */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* --- Navbar --- */
        .navbar {
            background: rgba(15, 23, 42, 0.85); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .navbar-brand span { color: var(--primary); font-weight: 800; }

        /* --- Form Inputs --- */
        .form-control, .form-select {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 8px;
        }
        .form-control:focus, .form-select:focus {
            background-color: rgba(0, 0, 0, 0.5);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }
        label { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px; }

        /* --- Buttons --- */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
        }
        
        .btn-outline-neon {
            color: var(--accent);
            border-color: var(--accent);
        }
        .btn-outline-neon:hover {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.6);
        }


        /* --- Stat Cards --- */
        .stat-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; }

        /* --- Table --- */
        .table-dark {
            --bs-table-bg: transparent;
            --bs-table-hover-bg: rgba(255,255,255,0.05);
        }
        th { color: var(--text-muted) !important; font-weight: 500; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        td { vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* --- Badges --- */
        .badge-severity-high { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #ef4444; }
        .badge-severity-medium { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid #f59e0b; }
        .badge-severity-low { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid #10b981; }

        /* --- Login/Register Screen --- */
        #auth-section {
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }
        .auth-box { width: 100%; max-width: 420px; padding: 40px; z-index: 10; }
        .auth-toggle { cursor: pointer; color: var(--accent); font-weight: 700; text-decoration: none; transition: 0.3s; }
        .auth-toggle:hover { text-shadow: 0 0 10px rgba(6, 182, 212, 0.6); }

        /* --- Modal --- */
        .modal-content { background-color: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); color: white; backdrop-filter: blur(20px); }
        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .modal-footer { border-top: 1px solid rgba(255,255,255,0.1); }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
        .detail-label { color: var(--text-muted); font-size: 0.9rem; }
        .detail-val { font-weight: 600; text-align: right; color: var(--text-main); }

        /* Loader */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="particles-js"></div>

    <section id="auth-section">
        
        <div id="login-card" class="glass-card auth-box fade-in">
            <div class="text-center mb-4">
                <i class="fas fa-heartbeat fa-3x text-primary mb-3"></i>
                <h2 class="fw-bold">SERBAS AI</h2>
                <p class="text-muted">Smart Emergency Bed Allocation</p>
            </div>
            <form id="login-form">
                <div class="mb-3">
                    <label>Hospital ID</label>
                    <input type="text" id="hid" class="form-control" placeholder="e.g. HOSP001" required>
                </div>
                <div class="mb-4">
                    <label>Password</label>
                    <input type="password" id="pass" class="form-control" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">Access Dashboard</button>
            </form>
            <div id="login-error" class="text-danger mt-2 text-center small"></div>
            <div class="text-center mt-3">
                <span class="text-white small fw-bold">New Hospital?</span> 
                <span class="auth-toggle ms-1" onclick="toggleAuth('register')">Register Here</span>
            </div>
        </div>

        <div id="register-card" class="glass-card auth-box fade-in" style="display: none;">
            <div class="text-center mb-4">
                <i class="fas fa-hospital-user fa-3x text-success mb-3"></i>
                <h2 class="fw-bold">Register Hospital</h2>
                <p class="text-muted">Create New System Access</p>
            </div>
            <form id="register-form">
                <div class="row g-2">
                    <div class="col-12">
                        <label>New Hospital ID</label>
                        <input type="text" id="reg_hid" class="form-control" placeholder="e.g. HOSP002" required>
                    </div>
                    <div class="col-12">
                        <label>Hospital Name</label>
                        <input type="text" id="reg_name" class="form-control" placeholder="e.g. City General" required>
                    </div>
                    <div class="col-12">
                        <label>Address</label>
                        <input type="text" id="reg_addr" class="form-control" placeholder="City, Area" required>
                    </div>
                    <div class="col-12">
                        <label>Password</label>
                        <input type="password" id="reg_pass" class="form-control" required>
                    </div>
                    <div class="col-6">
                        <label>Total Beds</label>
                        <input type="number" id="reg_total" class="form-control" value="100" required>
                    </div>
                    <div class="col-6">
                        <label>ICU Beds</label>
                        <input type="number" id="reg_icu" class="form-control" value="10" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100 mt-4 mb-3">Create Account</button>
            </form>
            <div id="register-error" class="text-danger mt-2 text-center small"></div>
            <div class="text-center mt-3">
                <span class="text-muted small">Already have an account?</span> 
                <span class="auth-toggle ms-1" onclick="toggleAuth('login')">Login Here</span>
            </div>
        </div>

    </section>

    <section id="dashboard-section" style="display: none;">
        
        <nav class="navbar navbar-expand-lg fixed-top">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center gap-3">
                    <a class="navbar-brand text-white" href="#">
                        <i class="fas fa-heartbeat text-primary me-2"></i>SERBAS <span>AI</span>
                    </a>
                    <button class="btn btn-sm btn-outline-neon rounded-circle" onclick="openSettings()" title="Manage Capacity">
                        <i class="fas fa-cog fa-spin-hover"></i>
                    </button>
                </div>
                <div class="d-flex align-items-center">
                    <span class="text-info fw-bold me-3 d-none d-md-block" id="hospital-name-display" style="text-shadow: 0 0 10px rgba(6, 182, 212, 0.3);">HOSPITAL NAME</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid px-4" style="margin-top: 80px;">
            
            <div class="row g-4 mb-4 fade-in">
                <div class="col-md-3 col-sm-6"><div class="glass-card p-3 d-flex align-items-center"><div class="stat-icon bg-primary bg-opacity-25 text-primary me-3"><i class="fas fa-bed"></i></div><div><div class="stat-value" id="stat-total">--</div><div class="stat-label">Total Capacity</div></div></div></div>
                <div class="col-md-3 col-sm-6"><div class="glass-card p-3 d-flex align-items-center"><div class="stat-icon bg-success bg-opacity-25 text-success me-3"><i class="fas fa-check-circle"></i></div><div><div class="stat-value" id="stat-available">--</div><div class="stat-label">Available Beds</div></div></div></div>
                <div class="col-md-3 col-sm-6"><div class="glass-card p-3 d-flex align-items-center"><div class="stat-icon bg-danger bg-opacity-25 text-danger me-3"><i class="fas fa-procedures"></i></div><div><div class="stat-value" id="stat-icu">--</div><div class="stat-label">ICU Occupancy</div></div></div></div>
                <div class="col-md-3 col-sm-6"><div class="glass-card p-3 d-flex align-items-center"><div class="stat-icon bg-warning bg-opacity-25 text-warning me-3"><i class="fas fa-exclamation-triangle"></i></div><div><div class="stat-value" id="stat-risk">--</div><div class="stat-label">High Risk Load</div></div></div></div>
            </div>

            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="glass-card p-4 fade-in h-100">
                        <h5 class="mb-4"><i class="fas fa-user-plus me-2 text-accent"></i>New Admission</h5>
                        <form id="admission-form">
                            <div class="row g-3">
                                <div class="col-12"><label>Patient Name</label><input type="text" id="p_name" class="form-control" required></div>
                                <div class="col-6"><label>Age</label><input type="number" id="p_age" class="form-control" required></div>
                                <div class="col-6"><label>Blood Group</label><select id="p_bg" class="form-select"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option></select></div>
                                <div class="col-12 mt-4 mb-2"><h6 class="text-primary small text-uppercase fw-bold border-bottom border-secondary pb-1">AI Triage Vitals</h6></div>
                                <div class="col-6"><label>Heart Rate (bpm)</label><input type="number" id="p_hr" class="form-control" placeholder="70-150" required></div>
                                <div class="col-6"><label>SpO2 (%)</label><input type="number" id="p_spo2" class="form-control" placeholder="80-100" required></div>
                                <div class="col-6"><label>BP Systolic</label><input type="number" id="p_sys" class="form-control" placeholder="120" required></div>
                                <div class="col-6"><label>BP Diastolic</label><input type="number" id="p_dia" class="form-control" placeholder="80" required></div>
                                <div class="col-6"><label>Temp (°C)</label><input type="number" step="0.1" id="p_temp" class="form-control" placeholder="37.0" required></div>
                                <div class="col-6"><label>Health Risk</label><select id="p_risk" class="form-select"><option value="stable">Stable</option><option value="moderate">Moderate</option><option value="critical">Critical</option></select></div>
                                <div class="col-12"><label>Admission Cause</label><input type="text" id="p_cause" class="form-control" required></div>
                                <div class="col-12"><label>Doctor Recommendation</label><select id="p_rec" class="form-select"><option value="general">General Ward</option><option value="flexible">Flexible Care</option><option value="icu">ICU (Intensive)</option></select></div>
                                <div class="col-12 mt-4"><button type="submit" class="btn btn-primary w-100 py-2"><i class="fas fa-robot me-2"></i> Run AI & Allocate Bed</button></div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="glass-card p-4 fade-in h-100">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0"><i class="fas fa-procedures me-2 text-accent"></i>Recent Allocations</h5>
                            <button class="btn btn-sm btn-outline-light" onclick="loadDashboardData()"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead><tr><th>Bed ID</th><th>Patient</th><th>Condition</th><th>ML Severity</th><th>Bed Type</th><th>Action</th></tr></thead>
                                <tbody id="patients-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-primary"><i class="fas fa-cogs me-2"></i>Manage Hospital Capacity</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted small mb-4">Update total beds. Note: Reducing capacity requires available (empty) beds.</p>
                    <form id="settings-form">
                        <div class="mb-3">
                            <label class="text-white">Total Hospital Beds</label>
                            <input type="number" id="set_total" class="form-control text-center text-primary fw-bold fs-4" required>
                        </div>
                        <div class="mb-3">
                            <label class="text-danger">ICU Capacity</label>
                            <input type="number" id="set_icu" class="form-control text-center text-danger fw-bold fs-4" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">APPLY CHANGES</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-primary"><i class="fas fa-id-card me-2"></i>Full Patient Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="modal-content">Loading...</div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex"><div class="toast-body" id="toast-msg"></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        particlesJS('particles-js', { "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#06b6d4" }, "shape": { "type": "circle" }, "opacity": { "value": 0.5, "random": false }, "size": { "value": 3, "random": true }, "line_linked": { "enable": true, "distance": 150, "color": "#3b82f6", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 2, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false } }, "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" }, "resize": true }, "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 1 } }, "push": { "particles_nb": 4 } } }, "retina_detect": true });
        const API_BASE = '/api';

        // --- AUTH SWITCH ---
        function toggleAuth(mode) {
            const loginCard = document.getElementById('login-card');
            const registerCard = document.getElementById('register-card');
            if (mode === 'register') {
                loginCard.style.display = 'none';
                registerCard.style.display = 'block';
            } else {
                loginCard.style.display = 'block';
                registerCard.style.display = 'none';
            }
        }

        // --- REGISTER LOGIC ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.innerText = 'Creating Account...';
            
            const payload = {
                hospital_id: document.getElementById('reg_hid').value,
                name: document.getElementById('reg_name').value,
                address: document.getElementById('reg_addr').value,
                contact: "000-0000",
                total_beds: parseInt(document.getElementById('reg_total').value),
                icu_beds: parseInt(document.getElementById('reg_icu').value),
                password: document.getElementById('reg_pass').value
            };

            try {
                const res = await fetch('/register', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if(data.success) {
                    alert('Registration Successful! Please Login.');
                    toggleAuth('login');
                    document.getElementById('register-form').reset();
                } else {
                    document.getElementById('register-error').innerText = data.message;
                }
            } catch(e) { document.getElementById('register-error').innerText = "Server Error"; }
            btn.innerText = 'Create Account';
        });

        // --- LOGIN LOGIC ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.innerHTML = '<span class="loader"></span> Authenticating...';
            try {
                const res = await fetch('/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ hospital_id: document.getElementById('hid').value, password: document.getElementById('pass').value }) });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('dashboard-section').style.display = 'block';
                    document.getElementById('hospital-name-display').innerText = data.hospital_name;
                    loadDashboardData();
                } else { document.getElementById('login-error').innerText = data.message; btn.innerHTML = 'Access Dashboard'; }
            } catch (error) { document.getElementById('login-error').innerText = "Server Error"; btn.innerHTML = 'Access Dashboard'; }
        });

        // --- CAPACITY SETTINGS ---
        function openSettings() {
            const total = document.getElementById('stat-total').innerText;
            if(total !== '--') document.getElementById('set_total').value = total;
            new bootstrap.Modal(document.getElementById('settingsModal')).show();
        }

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(confirm("Confirm capacity change?")) {
                try {
                    const res = await fetch(`${API_BASE}/update-capacity`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            total_beds: document.getElementById('set_total').value, 
                            icu_beds: document.getElementById('set_icu').value 
                        })
                    });
                    const data = await res.json();
                    if(data.success) { showToast("Capacity Updated", 'success'); loadDashboardData(); bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide(); }
                    else showToast(data.message, 'danger');
                } catch(e) { showToast("Update Failed", 'danger'); }
            }
        });

        // --- DASHBOARD FUNCTIONS ---
        async function loadDashboardData() {
            try {
                const res = await fetch(`${API_BASE}/dashboard-data`);
                if (res.status === 401) { logout(); return; }
                const data = await res.json();
                animateValue("stat-total", data.stats.total_beds);
                animateValue("stat-available", data.stats.available_beds);
                animateValue("stat-icu", data.stats.icu_beds);
                animateValue("stat-risk", data.stats.critical_load);
                loadFullPatientTable();
            } catch (e) { console.error("Dashboard Load Error", e); }
        }

        async function loadFullPatientTable() {
            const res = await fetch(`${API_BASE}/allocated-patients`);
            const data = await res.json();
            const tbody = document.getElementById('patients-table-body');
            tbody.innerHTML = '';
            data.patients.forEach(p => {
                let badgeClass = p.severity === 'high' ? 'badge-severity-high' : (p.severity === 'medium' ? 'badge-severity-medium' : 'badge-severity-low');
                // UPDATED: Made age prominent with text-accent and fw-bold
                tbody.innerHTML += `<tr><td class="fw-bold text-accent">${p.bed_id || 'WAITING'}</td><td>${p.name}<br><small class="text-accent fw-bold" style="font-size: 0.85em;">${p.age} yrs</small></td><td>${p.condition}</td><td><span class="badge ${badgeClass}">${p.severity.toUpperCase()}</span></td><td>${p.bed_type || p.doctor_recommendation}</td><td><button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${p.id}')"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-outline-success ms-1" onclick="discharge('${p.id}')"><i class="fas fa-check"></i></button></td></tr>`;
            });
        }

        document.getElementById('admission-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]'); btn.innerHTML = '<span class="loader"></span> Processing...';
            const payload = { patient_name: document.getElementById('p_name').value, age: document.getElementById('p_age').value, blood_group: document.getElementById('p_bg').value, heart_rate: document.getElementById('p_hr').value, spO2: document.getElementById('p_spo2').value, blood_pressure_systolic: document.getElementById('p_sys').value, blood_pressure_diastolic: document.getElementById('p_dia').value, temperature: document.getElementById('p_temp').value, admission_cause: document.getElementById('p_cause').value, health_risk: document.getElementById('p_risk').value, doctor_recommendation: document.getElementById('p_rec').value };
            try {
                const res = await fetch(`${API_BASE}/allocate-bed`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) { showToast(data.message, 'success'); document.getElementById('admission-form').reset(); loadDashboardData(); } else showToast(data.message, 'danger');
            } catch (e) { showToast("Error", 'danger'); }
            btn.innerHTML = '<i class="fas fa-robot me-2"></i> Run AI & Allocate Bed';
        });

        async function viewDetails(pid) {
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            document.getElementById('modal-content').innerHTML = '<div class="text-center"><span class="loader"></span> Fetching records...</div>';
            modal.show();
            const res = await fetch(`${API_BASE}/patient-details/${pid}`);
            const d = (await res.json()).details;
            document.getElementById('modal-content').innerHTML = `
                <div class="p-2"><h4 class="text-white mb-3 text-center">${d.name} <span class="badge bg-secondary ms-2 small">${d.patient_id}</span></h4>
                <div class="row mb-4 gx-2"><div class="col-4"><div class="glass-card p-2 text-center h-100"><div class="h4 text-accent mb-0">${d.spO2}%</div><small class="text-accent">SpO2</small></div></div><div class="col-4"><div class="glass-card p-2 text-center h-100"><div class="h4 text-danger mb-0">${d.heart_rate}</div><small class="text-danger">BPM</small></div></div><div class="col-4"><div class="glass-card p-2 text-center h-100"><div class="h4 text-warning mb-0">${d.temperature}°</div><small class="text-warning">Temp</small></div></div></div>
                <h6 class="text-primary small fw-bold mb-3 border-bottom border-secondary pb-1">CLINICAL PROFILE</h6>
                <div class="detail-row"><span class="detail-label">Age / Blood:</span><span class="detail-val text-white">${d.age} / ${d.blood_group}</span></div><div class="detail-row"><span class="detail-label">Condition:</span><span class="detail-val text-white">${d.condition}</span></div><div class="detail-row"><span class="detail-label">Blood Pressure:</span><span class="detail-val text-accent">${d.bp_systolic}/${d.bp_diastolic} mmHg</span></div><div class="detail-row"><span class="detail-label">Risk:</span><span class="detail-val text-info">${d.triage_risk_level.toUpperCase()}</span></div><div class="detail-row"><span class="detail-label">Recommendation:</span><span class="detail-val text-white">${d.doctor_recommendation.toUpperCase()}</span></div>
                <h6 class="text-primary small fw-bold mt-4 mb-3 border-bottom border-secondary pb-1">LOGISTICS</h6>
                <div class="detail-row"><span class="detail-label">Prediction:</span><span class="detail-val text-accent fw-bold">${d.ml_severity.toUpperCase()}</span></div><div class="detail-row"><span class="detail-label">Cluster:</span><span class="detail-val text-warning">${d.risk_flag}</span></div><div class="detail-row"><span class="detail-label">Score:</span><span class="detail-val text-white">${d.priority_score}</span></div><div class="detail-row"><span class="detail-label">Assigned:</span><span class="detail-val text-success fw-bold">${d.bed_id}</span></div><div class="detail-row"><span class="detail-label">Admitted:</span><span class="detail-val text-white">${d.admission_date}</span></div><div class="detail-row"><span class="detail-label">Discharge:</span><span class="detail-val text-white">${d.expected_stay_days} Days</span></div></div>`;
        }

        async function discharge(pid) { if(!confirm("Discharge patient?")) return; await fetch(`${API_BASE}/discharge-patient`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({patient_id: pid}) }); showToast("Discharged", "success"); refreshAll(); }
        async function logout() { await fetch('/logout'); location.reload(); }
        function showToast(msg, type) { const t = document.getElementById('liveToast'); document.getElementById('toast-msg').innerText = msg; t.classList.remove('bg-primary','bg-danger','bg-success'); t.classList.add(`bg-${type}`); new bootstrap.Toast(t).show(); }
        function animateValue(id, end) { document.getElementById(id).innerText = end; }
    </script>
</body>
</html>